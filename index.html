<!DOCTYPE html>
<html>

<head>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
        AFRAME.registerComponent('markerhandler', {
            init: function () {
                let marker = this.el;
                let model = document.querySelector('#car-model');
                let lastPosition = new THREE.Vector3();
                let lastRotation = new THREE.Quaternion(); // Fix: Use Quaternion to properly store rotation

                marker.addEventListener('markerFound', () => {
                    console.log("Marker found! Showing model.");
                    model.setAttribute('visible', true);

                    // Get world position and rotation from marker
                    marker.object3D.getWorldPosition(lastPosition);
                    marker.object3D.getWorldQuaternion(lastRotation); // Fix: Store rotation properly

                    // Apply the position and rotation to the model
                    model.object3D.position.copy(lastPosition);
                    model.object3D.quaternion.copy(lastRotation);
                });

                marker.addEventListener('markerLost', () => {
                    console.log("Marker lost! Keeping model in place.");

                    // Keep model at last known position and rotation
                    model.object3D.position.copy(lastPosition);
                    model.object3D.quaternion.copy(lastRotation); // Fix: Restore rotation correctly

                    // Ensure the model remains visible
                    model.setAttribute('visible', true);
                });
            }
        });



        AFRAME.registerComponent('clicker', {
            init: function () {
                this.soundEl = document.querySelector('#click-sound');
                this.el.addEventListener('click', () => {
                    this.soundEl.components.sound.playSound();
                });
            }
        });
    </script>
</head>

<body style='margin: 0; overflow: hidden;'>

    <a-scene embedded arjs vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false" renderer="antialias: true; alpha: true"
        cursor="rayOrigin: mouse" raycaster="objects: .clickable">

        <!-- Adding a simple Hiro marker for testing -->
        <a-marker preset="hiro" markerhandler>
            <a-entity id="car-model" gltf-model="https://ses011.github.io/MallMixAR.github.io/porsche/scene.gltf"
                scale="0.5 0.5 0.5" rotation="-90 0 0" position="0 0 0" visible="false" clicker>
            </a-entity>
        </a-marker>

        <a-entity id="click-sound"
            sound="src: https://ses011.github.io/MallMixAR.github.io/car-horn.mp3; autoplay: false"></a-entity>

        <a-camera><a-cursor></a-cursor></a-camera>

    </a-scene>

</body>

</html>